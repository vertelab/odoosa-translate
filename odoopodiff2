#!/usr/bin/python3
import base64
import requests
from pathlib import Path
import os
import polib
import re
import subprocess 
import sys

def detect_odoo_version():
    """HÃ¤mtar Odoo version automatiskt."""
    for cmd in ["odoo-bin --version", "odoo --version"]:
        try:
            result = subprocess.run(cmd.split(), capture_output=True, text=True, timeout=10)
            match = re.search(r'(\d+)', result.stdout)
            if match:
                return f"odoo-{match.group(1)}"
        except:
            pass
    print("âŒ AnvÃ¤nder fallback: odoo-18")
    return "odoo-18"

def find_github_files(version):
    """HÃ¤mtar filer frÃ¥n GitHub API istÃ¤llet fÃ¶r lokal mapp."""
    url = "https://api.github.com/repos/vertelab/odoosa-translate/git/trees/main?recursive=1"
    resp = requests.get(url)
    data = resp.json()
    
    files = []
    pattern = re.compile(rf'^{version}-([a-z0-9_-]+)-sv\.po$')
    
    for item in data["tree"]:
        if item["type"] == "blob" and pattern.search(item["path"]):
            match = pattern.search(item["path"])
            files.append({
                'path': item["path"],
                'module': match.group(1),
                'sha': item["sha"]
            })
    
    print(f"âœ… GitHub: {len(files)} filer: {[f['module'] for f in files]}")
    return files

def download_github_content(file_info):
    """HÃ¤mtar GitHub-fil via SHA."""
    sha = file_info['sha']
    url = f"https://api.github.com/repos/vertelab/odoosa-translate/git/blobs/{sha}"
    resp = requests.get(url)
    resp.raise_for_status()
    blob = resp.json()
    return base64.b64decode(blob["content"]).decode("utf-8")


def download_weblate_po(version, module, token):
    """HÃ¤mtar frÃ¥n Weblate med felsÃ¶kning."""
    url = f"https://translate.odoo.com/api/translations/{version}/{module}/sv/file/"
    headers = {'Authorization': f'Token {token}', 'Accept': 'text/x-po'}
    
    print(f"ğŸŒ Weblate URL: {url}")
    resp = requests.get(url, headers=headers)
    
    print(f"ğŸ“¡ Status: {resp.status_code}")
    print(f"ğŸ“¡ Headers: {dict(resp.headers)}")
    
    if resp.status_code != 200:
        print(f"âŒ Weblate FEL: {resp.text[:500]}...")  # FÃ¶rsta 500 tecken
        raise Exception(f"Weblate API fel: {resp.status_code}")
    
    content_preview = resp.text[:200] + "..." if len(resp.text) > 200 else resp.text
    print(f"âœ… Weblate OK: {len(resp.text)} tecken. FÃ¶rhandsvisning: {content_preview}")
    
    return resp.text

def update_odoo_local(github_str, module):
    """FORCE: GitHub Ã–VERSÃ„TTNINGAR skriver Ã¶ver Odoo."""
    local_path = Path('/usr/share/core-odoo/addons') / module / 'i18n' / 'sv.po'
    
    github_po = polib.pofile(github_str)
    translated = [e for e in github_po if e.msgstr.strip()]
    
    print(f"ğŸ“¦ GitHub: {len(translated)} Ã¶versatta fraser")
    
    # SKRIV Ã–VER lokala filen med GitHub-innehÃ¥ll
    github_po.save(str(local_path))
    print(f"âœ… {len(translated)} Ã¶versÃ¤ttningar SKRIVNA â†’ {local_path}")

def main():
    import os
    if os.geteuid() != 0:
        print("ğŸ”’ KrÃ¤ver sudo...")
        os.execvp("sudo", ["sudo", sys.executable, __file__])
    
    print("ğŸ”„ GitHub â†’ Odoo sync...")
    version = detect_odoo_version()
    
    files = find_github_files(version)
    if not files:
        print("âŒ Inga filer!")
        return
    
    for file_info in files:
        module = file_info['module']
        print(f"\nğŸ”„ [{module}]")
        github_str = download_github_content(file_info)  # Fungerar nu!
        update_odoo_local(github_str, module)


if __name__ == "__main__":
    main()
